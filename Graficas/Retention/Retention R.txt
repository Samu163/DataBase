# --- INICIO DEL CÓDIGO ---

# 1. INSTALAR Y CARGAR PAQUETES
# install.packages("tidyverse") # Descomenta esta línea si no tienes el paquete 'tidyverse'
library(tidyverse)

# 2. CARGAR LOS DATOS
# ¡¡CAMBIA "tu_archivo.csv" POR EL NOMBRE DE TU ARCHIVO!!
df_ret <- read.csv("tu_archivo.csv")

# 3. VERIFICAR COLUMNAS (DEBUG)
print("Columnas cargadas en el archivo:")
print(names(df_ret))

# 4. PREPARAR LOS DATOS (PIVOTAR Y CALCULAR PROMEDIOS)

# Primero, pivotamos los datos (como antes)
df_ret_long <- df_ret %>%
  pivot_longer(
    cols = c("d1_percentage", "d3_percentage", "d7_percentage"),
    names_to = "retention_type", # Nueva columna para "D1", "D3", "D7"
    values_to = "percentage"     # Nueva columna para los valores
  ) %>%
  filter(!is.na(percentage)) # Elimina filas donde el porcentaje es NA

# Segundo, calculamos el promedio de cada grupo
df_avg <- df_ret_long %>%
  group_by(retention_type) %>%
  summarise(average_percentage = mean(percentage, na.rm = TRUE))


# 5. CREAR LA GRÁFICA DE BARRAS
if (nrow(df_avg) > 0) {
    
    # 'reorder' ordena las barras de mayor a menor
    ggplot(data = df_avg, aes(x = reorder(retention_type, -average_percentage), 
                               y = average_percentage, 
                               fill = retention_type)) +
        
        # Capa 1: Las barras
        geom_bar(stat = "identity") +
        
        # Capa 2: Texto con el valor encima de cada barra
        # 'round(..., 1)' redondea el número a 1 decimal
        geom_text(
          aes(label = paste0(round(average_percentage, 1), "%")), 
          vjust = -0.5 # Ajusta la posición vertical del texto
        ) +
        
        # Capa 3: Títulos y etiquetas
        labs(
            title = "Overall Average Retention (D1, D3, D7)",
            x = "Retention Type",
            y = "Average Percentage (%)"
        ) +
        
        # Capa 4: Tema limpio
        theme_minimal() +
        
        # Capa 5: Quitar la leyenda (es redundante)
        theme(legend.position = "none")
    
} else {
    print("Data frame is empty, has NAs, or was not loaded correctly.")
}

# --- FIN DEL CÓDIGO ---